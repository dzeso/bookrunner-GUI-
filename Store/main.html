<script>

Vue.use(Vuex);

// this.emptyArray({rows: 1, cols: 3, data: [0,0,0]})},

var store = new Vuex.Store ({
  state: { 
    exchanges: {
      Okex: {teir: 0, equity: 0, hstEquityDTeir: []}, 
      },
    groups: [
      {name: "Weekly", date: "0622", teir: 0, equity: 0},
      {name: "Bi-weekly", date: "0629", teir: 0, equity: 0},
      {name: "Quarterly", date: "0928", teir: 0, equity: 0},
      ],
    groupsIndex: { // приходится так делать из-за того, что ключи объектов выдаются в произвольном порядке
      Weekly: 0,
      "Bi-weekly": 1,
      Quarterly: 2
      },
    instruments:  [
      {name: "BTC", price: 6503.35, limit: 1000, vol: 5000},
      {name: "LTC", price: 95.839, limit: 10000, vol: 10000},
      {name: "ETH", price: 500.870, limit: 10000, vol: 20000},
      {name: "BTH", price: 850.978, limit: 10000, vol: 15000},
      {name: "XRP", price: 0.530, limit: 10000, vol: 10000},
      {name: "EOS", price: 10.434, limit: 10000, vol: 50000},
      ],
    trends: ["top", "flatTop", "flat", "flatDown", "down", ],
    arrow: {
      top: "↑",
      flatTop: "↗",
      flat: "→",
      flatDown: "↘",
      down: "↓",  
      },
    tradeState: {
      stop: {name: "stop", color: "grey"},
      pause: {name: "pause", color: "amber"},
      run: {name: "run", color: ""},
      landing: {name: "landing", color: "light-green"},
      reconnect: {name: "reconnect", color: "blue-grey"},
      error: {name: "error", color: "red lighten-3"},
      },
    },
  getters: { 
    exchanges (state) {  
       return state.exchanges;
       },
    groups (state) {  
       return state.groups;
       },
    groupsIndex (state) {  
       return state.groups;
       },
    instruments (state) {  
       return state.instruments;
       },
    trends (state) {  
       return state.trends;
       },
    arrow (state) {  
       return state.arrow;
       },
    tradeState (state) {  
       return state.tradeState;
       },
    },
  mutations: {
    setObjReactive (state, obj) {      
      Vue.set(obj, 'setObjReactive', 42); /* (todo проверить актуальность) принудительное обновление объекта для реактивности*/
      Vue.delete(obj, 'setObjReactive');
      },
    
    updHstEquityDTeir (state, payload) {     
//      console.log ("updHstEquityDTeir hstEquityDTeir in", payload, state.exchanges[payload.name].hstEquityDTeir);
//      state.exchanges[payload.name].hstEquityDTeir.shift();
      state.exchanges[payload.name].hstEquityDTeir.push([payload.date, payload.equity, 0]);
//      console.log ("updHstEquityDTeir hstEquityDTeir out", payload, state.exchanges[payload.name].hstEquityDTeir);
      },
      
    setExchangeData (state, payload) {
      state.exchanges[payload.name].teir += payload.dTeir;
      state.exchanges[payload.name].equity += payload.dEquity;
      const lastIndex = state.exchanges[payload.name].hstEquityDTeir.length-1;
      state.exchanges[payload.name].hstEquityDTeir[lastIndex][1] = state.exchanges[payload.name].equity;
      state.exchanges[payload.name].hstEquityDTeir[lastIndex][2] += payload.dTeir;
      },
    
    setGroupData (state, payload) {
      const index = state.groupsIndex[payload.name];
      state.groups[index].teir += payload.dTeir;
      state.groups[index].equity += payload.dEquity;
//      console.log ("setGroupData", state.groups[index]);
       },
    },
  actions: {
     setExchangeData ({commit, state}, payload) {
       const 
         newTime = (new Date()).toTimeString().slice(0,7)+"0",
         lastIndex = state.exchanges[payload.name].hstEquityDTeir.length-1;
       let oldTime = (lastIndex<0 ? "" : state.exchanges[payload.name].hstEquityDTeir[lastIndex][0]);
//       console.log ("setExchangeData", date, state.exchanges);
       if ( newTime != oldTime) {
         commit("updHstEquityDTeir", {
           name: payload.name,
           date: newTime,
           equity: state.exchanges[payload.name].equity
           });
         }
       commit("setExchangeData", payload);
//       commit('setObjReactive', state.exchanges);
       },
     setGroupData ({commit}, payload) {
       commit("setGroupData", payload);
       },
    }, 
  modules: {
    FakeDom
    }
});
console.log ("store main started");
</script>