<script type="text/x-template" id="chart-test-template">
 <div> 
  <chart-google-standart
     chartType="LineChart"
     :chartData="chartIndexData"
     :chartConfig="chartOptions"
  />
  <chart-google-standart
     chartType="AreaChart"
     :chartData="chartIndexData"
     :chartConfig="chartIndexConfig"
  />
</div> 
</script>

<script>
  var chartTest = {
    template: "#chart-test-template",
    
    props: {
        },
    
    components: {
       ChartGoogleStandart: ChartGoogleStandart,
       },

    mounted() {
      
      let 
        startTime = getISODateFromStamp({
          timestamp: Date.now(),
          mode: this.chartTimeMode
        });
        
//      console.log("startTime", startTime);
//      console.log("getTimeFromISODate startTime", getTimeFromISODate({
//               date: startTime, 
//               mode: this.chartTimeMode
//             }));
      this.chartIndex.header = getIndexAsArray(this.coinsIndex);
      this.chartIndex.header[0] = "time";
      this.chartIndex.lastRecord = startTime;
      this.chartIndex.cacheData = getEmptyChartArray({
        colsNumber: this.chartIndex.header.length,
        rowsNumber: this.chartIndex.depth,
        firstRowVal: { 
          f: getTimeFromISODate({
               date: startTime, 
               mode: this.chartTimeMode
             }),
          a: { f: 0, v: 0, },
        },
        rowsVal: {
          f: "",
          a: undefined
        }
      });
      
      console.log("------ инит this.chartIndex.depth", this.chartIndex.depth);
      console.log("------ инит this.chartIndex.cacheData", this.chartIndex.cacheData);

      this.chartContractMarketPrice.header = getIndexAsArray(this.coinsIndex);
      
      for (let group in this.groups) {
        this.chartContractMarketPrice[group] = {};
        this.chartContractMarketPrice[group].lastRecord = startTime;
        this.chartContractMarketPrice[group].cacheIndex = 0;
        this.chartContractMarketPrice[group].cacheData = getEmptyChartArray({
        colsNumber: this.chartContractMarketPrice.header.length,
        rowsNumber: this.chartContractMarketPrice.depth,
        firstRowVal: { 
          f: getTimeFromISODate({
               date: startTime, 
               mode: this.chartTimeMode
             }),
          a: { f: 0, v: 0, }
          },
        rowsVal: {
          f: "",
          a: undefined}
        });
        } 

      console.log("------ инит this.chartIndex", this.chartIndex);
      console.log("this.chartContractMarketPrice", this.chartContractMarketPrice);
      },
      
    computed: {
    
      chartMarketPriceDataThisWeek () {  
//        console.log("this.hstContractMarketPrice", this.hstContractMarketPrice);
//        let firstRecord =  param.group.firstRecord,
//            lastRecord =  param.group.lastRecord,
//            currentRecord = param.currentRecord;
//          if (!param.currentRecord && firstRecord) {
//            currentRecord = firstRecord;
//          };
//          let currentRecord = lastCacheRecord;
//        
//        let newData = getNewMarketPrices({
//          hstContractMarketPrice.this_week,
//          currentRecord,
//          lastRecord,
//          instrumentIndex: coinsOrder,
//          timeMode: param.timeMode,
//          dataKey: param.dataKey}),
//          lastCacheRecord,
//          }
//          
//        let newData = getMarketPriceDataForGroup({
//          data:hstContractMarketPrice.this_week
//        }"this_week");          
//        if pushMarketPriceDataForGroupToCache ("this_week", newData) {
//          this.chartContractMarketPrice.lastRecord[group] = getNextRecord({
//            date: newData[newData.length - 1][0],
//            mode: this.chartTimeMode
//          });
//        };
//       
//       return [this.chartMarketPrice.header].concat(this.chartMarketPrice.dataCache.slice(this.chartMarketPrice.dataCache.length-this.chartMarketPrice.depth));
     },
      
      chartIndexData () {  
//        console.log("chartIndexData обновление", this.hstIndexData);
        console.log("this.hstIndexData", this.hstIndexData);
        console.log("this.hstContractMarketPrice", this.hstContractMarketPrice);
        let lastRecord = this.hstIndexData.lastRecord;
        let currentRecord = this.chartIndex.lastRecord;
        console.log("lastRecord", lastRecord);
        console.log("currentRecord", currentRecord);
        
        let newData = getNewDataArrayFromObjectByDate({
          data: this.hstIndexData,
          instrumentIndex: this.coinsIndex,
          currentRecord,
          lastRecord,
          timeMode: this.chartTimeMode
          });
        
        console.log("newData", newData);
        
        let newChartData = newData.map((value) => {
          return value.map((value, index) => {
            if (index > 0) {
              if (!this.chartIndex.normalizeBase[index]) this.chartIndex.normalizeBase[index] = value;
              value = {
                f: value,
                v: getNormalizedValue({
                  value,
                  base: this.chartIndex.normalizeBase[index],
                  k: 1000
                }), 
              };
            }
            return value;
          });
        });
        
        console.log("newChartData", newChartData);
        
        if (newChartData.length > 0) {
          newChartData.forEach((value, index) => {
            this.chartIndex.cacheData[index + this.chartIndex.cacheIndex] = Array.from(value);
          });
          this.chartIndex.cacheIndex += newChartData.length;
          this.chartIndex.lastRecord = getNextRecord({
            date: newData[newData.length-1][0],
            mode: this.chartTimeMode
          });
        }; 
        
        console.log("this.chartIndex.cacheData", this.chartIndex.cacheData);
        console.log("this.chartIndex.cacheIndex", this.chartIndex.cacheIndex);
        console.log("this.chartIndex.lastRecord", this.chartIndex.lastRecord);

        return [this.chartIndex.header].concat(this.chartIndex.cacheData.slice(this.chartIndex.cacheData.length-this.chartIndex.depth));
        },
        
      hstIndexData () {  
        return this.$store.getters.okexData.index || {};
        },
      hstContractMarketPrice () {  
        return this.$store.getters.okexData.contractMarketPrice || {};
        },
      chartTimeMode () {  
        return this.$store.getters.okexData.config.frameTimeMode;
        },
      coinsIndex () {  
        return this.$store.getters.coinsOrder;
        },
      groups () {  
        return this.$store.getters.okexData.futures.groups;
        },
      },
    methods: {
    
      getMarketPriceDataForGroup (param) {  
//          let
//            firstRecord =  param.group.firstRecord,
//            lastRecord =  param.group.lastRecord,
//            currentRecord = param.currentRecord;
//          if (!param.currentRecord && firstRecord) {
//            currentRecord = firstRecord;
//          };
//          let currentRecord = lastCacheRecord;
//          
//          return {
//            data: getNewMarketPrices({
//              param.group,
//              currentRecord,
//              lastRecord,
//              instrumentIndex: coinsOrder,
//              timeMode: param.timeMode,
//              dataKey: param.dataKey}),
//            lastCacheRecord,
//            }
      },
      
      pushMarketPriceDataForGroupToCache (group, data) {  
      },
    },
    data () {
      return {    
        
        chartIndex: {
          cacheData: [[]],
          lastRecord: 0,
          cacheIndex: 0,
          normalizeBase: [],
          header: [],
          depth: 30,
        },
          
        chartContractMarketPrice: {
          header: [],
          depth: 30,
          /* Структура динамически создаваемых данных           
            "группа": { 
              cacheData: [[]],
              lastRecord: 0,
              cacheIndex: 0,
              },
          */ 
        },

        chartOptions: { 
          height: 400,
          curveType: 'none',
          vAxisLogscale: true,
          vAxisScaleType: "mirrorLog",
          interpolateNulls: true,
          },
        chartIndexConfig: { 
          title: "Изменение курсов в ‱",
          height: 400,
          curveType: 'none',
          vAxisLogscale: false,
          interpolateNulls: true,
          },
       }  
    }
  };
console.log ("chart-test started");
</script>
