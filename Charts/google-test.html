<script type="text/x-template" id="chart-test-template">
 <div> 
  <chart-google-standart
     chartType="LineChart"
     :chartData="chartData"
     :chartConfig="chartOptions"
  />
  <chart-google-standart
     chartType="AreaChart"
     :chartData="chartData"
     :chartConfig="chartOptions1"
  />
</div> 
</script>

<script>
  var chartTest = {
    template: "#chart-test-template",
    
    props: {
        },
    
    components: {
       ChartGoogleStandart: ChartGoogleStandart,
       },

    mounted() {
      for (let coin in this.$store.getters.coinsOrder) {
        this.chartDataHeader[this.$store.getters.coinsOrder[coin]] = coin;
        this.chartDataCache[0][this.$store.getters.coinsOrder[coin]] = {
                f: 0,
                v: 0, 
                };
      }; 
      
      this.chartDataCache[0][0] = getTimeFromISODate({date: (new Date).toISOString(), mode: this.chartDataTimeMode}); // todo 
      
      for (let i=1; i<this.chartDataDepth; i++) { 
        this.chartDataCache[i]=[];
        this.chartDataCache[i][0]="";
        this.chartDataCache[i][this.chartDataHeader.length - 1]=undefined;
        }
//      console.log("this.chartDataCache", this.chartDataCache);
      },
      
    computed: {
      chartData () {  
//        console.log("chartData обновление", this.hstIndexData);
        if (!this.hstIndexData.firstRecord) return [this.chartDataHeader];

        let
          firstRecord = this.hstIndexData.firstRecord,
          lastRecord = this.hstIndexData.lastRecord;
          
        if (!this.chartDataLastMoment && firstRecord) {
          this.chartDataLastMoment = firstRecord;
//          console.log("this.hstIndexData.firstRecord", firstRecord);
          }
        let currentMoment = this.chartDataLastMoment;
        while (currentMoment < lastRecord) {
          let nextMoment = getNextMoment({
            date: currentMoment,
            mode: this.chartDataTimeMode}
            );
          if (this.hstIndexData [currentMoment]) {
            console.log("this.chartDataCacheIndex", this.chartDataCacheIndex);
            console.log("this.chartDataDepth", this.chartDataDepth);
            if ( this.chartDataCacheIndex >= this.chartDataDepth) {
              console.log("this.chartDataCache.length - last", this.chartDataCache.length);
              this.chartDataCache.push([]);
              console.log("this.chartDataCache.length", this.chartDataCache.length);
              this.chartDataCache[this.chartDataCacheIndex][this.chartDataHeader.length - 1] = undefined;
              };
            console.log("this.chartDataCache", this.chartDataCache);
            this.chartDataCache[this.chartDataCacheIndex][0] =  getTimeFromISODate({date: currentMoment, mode: this.chartDataTimeMode}); // вставляем дату
            
            for (let coin in this.hstIndexData [currentMoment]) {
              let coinIndex = this.$store.getters.coinsOrder[coin];
              let currentValue = this.hstIndexData [currentMoment][coin];
              if (!this.chartDataNormalizeBase[coinIndex]) this.chartDataNormalizeBase[coinIndex] = currentValue; // фиксируем базу нормализации если ее еще нет
              let normalizedValue = (currentValue/this.chartDataNormalizeBase[coinIndex] - 1)*10000; // todo в функцию             
              
              this.chartDataCache[this.chartDataCacheIndex][coinIndex] = {
                f: currentValue,
                v: normalizedValue, 
                };
              }; 
            this.chartDataCacheIndex++;
            this.chartDataLastMoment = nextMoment; 
            }
          else {
            console.log("В базе нет", currentMoment);
            };
          currentMoment = nextMoment;
          };
        // todo - херота! надо рассчитывать, чтоб показывались последние chartDataDepth значений 
//        console.log("chartData", this.chartDataCache.slice(this.chartDataCache.length-this.chartDataDepth));
        return [this.chartDataHeader].concat(this.chartDataCache.slice(this.chartDataCache.length-this.chartDataDepth));
        },
        
      hstIndexData () {  
//        console.log("dom-chart hstInstrumentTradeData", this.$store.getters.hstInstrumentTradeData[this.nmInstrument] || []);
        return this.$store.getters.okexData.index || {};
        },
      chartDataTimeMode () {  
        return this.$store.getters.okexData.config.frameTimeMode;
        },
      },
    methods: {
      },
    data () {
      return {    
        chartDataCache: [[]],
        chartDataLastMoment: 0,
        chartDataCacheIndex: 0,
        chartDataNormalizeBase: [],
        chartDataHeader: ["time"],
        chartDataDepth: 30,

        chartOptions: { 
          height: 400,
          curveType: 'none',
          vAxisLogscale: true,
          vAxisScaleType: "mirrorLog",
          interpolateNulls: true,
          },
        chartOptions1: { 
          title: "Изменение курсов в ‱",
          height: 400,
          curveType: 'none',
          vAxisLogscale: false,
          interpolateNulls: true,
          },
       }  
    }
  };
console.log ("chart-test started");
</script>
